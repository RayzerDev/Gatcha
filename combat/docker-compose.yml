services:
  mongodb:
    image: mongo:8.2.3
    container_name: mongodb-combat-local
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    ports:
      - "27021:27017"
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.runCommand({ping:1}).ok' --quiet"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  api:
    build:
      context: ..
      dockerfile: api.Dockerfile
      args:
        SERVICE_NAME: combat
    container_name: api-combat-local
    ports:
      - "8085:8080"
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      MONGO_USERNAME: root
      MONGO_PASSWORD: example
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      MONGO_DATABASE: combatdb
      AUTH_API_URL: http://host.docker.internal:8081
      MONSTER_API_URL: http://host.docker.internal:8083
      PLAYER_API_URL: http://host.docker.internal:8082
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

volumes:
  mongo-data:
