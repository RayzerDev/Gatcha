# ============================================
# YAML Anchors - Configuration r√©utilisable
# ============================================
x-mongodb-common: &mongodb-common
  image: mongo:8.2.3
  restart: unless-stopped
  environment: &mongodb-env
    MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-root}
    MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-example}
  networks:
    - gatcha-network
  healthcheck: &mongodb-healthcheck
    test:
      [
        "CMD-SHELL",
        "echo 'db.runCommand(\"ping\").ok' | mongosh localhost:27017/test --quiet"
      ]
    interval: 3s
    timeout: 2s
    retries: 5
    start_period: 3s

x-api-common: &api-common
  build:
    context: .
    dockerfile: api.Dockerfile
  restart: unless-stopped
  networks:
    - gatcha-network
  environment: &api-env-base
    MONGO_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-root}
    MONGO_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-example}
    MONGO_PORT: ${MONGO_PORT:-27017}

services:
  # ============================================
  # MongoDB Databases
  # ============================================

  mongodb-auth:
    <<: *mongodb-common
    container_name: mongodb-auth
    ports:
      - "${MONGO_AUTH_PORT:-27017}:27017"
    volumes:
      - mongo-data-auth:/data/db

  mongodb-player:
    <<: *mongodb-common
    container_name: mongodb-player
    ports:
      - "${MONGO_PLAYER_PORT:-27018}:27017"
    volumes:
      - mongo-data-player:/data/db

  mongodb-monster:
    <<: *mongodb-common
    container_name: mongodb-monster
    ports:
      - "${MONGO_MONSTER_PORT:-27019}:27017"
    volumes:
      - mongo-data-monster:/data/db

  mongodb-invocation:
    <<: *mongodb-common
    container_name: mongodb-invocation
    ports:
      - "${MONGO_INVOCATION_PORT:-27020}:27017"
    volumes:
      - mongo-data-invocation:/data/db

  mongodb-combat:
    <<: *mongodb-common
    container_name: mongodb-combat
    ports:
      - "${MONGO_COMBAT_PORT:-27021}:27017"
    volumes:
      - mongo-data-combat:/data/db

  # ============================================
  # API Gateway
  # ============================================

  api-gateway:
    image: nginx:alpine
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT:-8000}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      api-auth:
        condition: service_healthy
      api-player:
        condition: service_healthy
      api-monster:
        condition: service_healthy
      api-invocation:
        condition: service_healthy
      api-combat:
        condition: service_healthy
    networks:
      - gatcha-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --tries=1 --spider http://127.0.0.1/health || exit 1" ]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 3s

  # ============================================
  # Frontend Next.js
  # ============================================

  front:
    build:
      context: .
      dockerfile: front.Dockerfile
    container_name: front
    restart: unless-stopped
    ports:
      - "${FRONT_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://localhost:${GATEWAY_PORT:-8000}
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - gatcha-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --tries=1 --spider http://127.0.0.1:3000 || exit 1" ]
      interval: 3s
      timeout: 2s
      retries: 3
      start_period: 5s

  # ============================================
  # Spring Boot APIs
  # ============================================

  api-auth:
    <<: *api-common
    build:
      context: .
      dockerfile: api.Dockerfile
      args:
        SERVICE_NAME: auth
    container_name: api-auth
    ports:
      - "${API_AUTH_PORT:-8081}:8080"
    depends_on:
      mongodb-auth:
        condition: service_healthy
    environment:
      <<: *api-env-base
      MONGO_HOST: mongodb-auth
      MONGO_DATABASE: authdb

  api-player:
    <<: *api-common
    build:
      context: .
      dockerfile: api.Dockerfile
      args:
        SERVICE_NAME: player
    container_name: api-player
    ports:
      - "${API_PLAYER_PORT:-8082}:8080"
    depends_on:
      mongodb-player:
        condition: service_healthy
      api-auth:
        condition: service_healthy
    environment:
      <<: *api-env-base
      MONGO_HOST: mongodb-player
      MONGO_DATABASE: playerdb
      AUTH_API_URL: ${AUTH_API_URL:-http://api-auth:8080}

  api-monster:
    <<: *api-common
    build:
      context: .
      dockerfile: api.Dockerfile
      args:
        SERVICE_NAME: monster
    container_name: api-monster
    ports:
      - "${API_MONSTER_PORT:-8083}:8080"
    depends_on:
      mongodb-monster:
        condition: service_healthy
      api-auth:
        condition: service_healthy
    environment:
      <<: *api-env-base
      MONGO_HOST: mongodb-monster
      MONGO_DATABASE: monsterdb
      AUTH_API_URL: ${AUTH_API_URL:-http://api-auth:8080}

  api-invocation:
    <<: *api-common
    build:
      context: .
      dockerfile: api.Dockerfile
      args:
        SERVICE_NAME: invocation
    container_name: api-invocation
    ports:
      - "${API_INVOCATION_PORT:-8084}:8080"
    depends_on:
      mongodb-invocation:
        condition: service_healthy
      api-auth:
        condition: service_healthy
      api-monster:
        condition: service_healthy
      api-player:
        condition: service_healthy
    environment:
      <<: *api-env-base
      MONGO_HOST: mongodb-invocation
      MONGO_DATABASE: invocationdb
      AUTH_API_URL: ${AUTH_API_URL:-http://api-auth:8080}
      MONSTER_API_URL: ${MONSTER_API_URL:-http://api-monster:8080}
      PLAYER_API_URL: ${PLAYER_API_URL:-http://api-player:8080}

  api-combat:
    <<: *api-common
    build:
      context: .
      dockerfile: api.Dockerfile
      args:
        SERVICE_NAME: combat
    container_name: api-combat
    ports:
      - "${API_COMBAT_PORT:-8085}:8080"
    depends_on:
      mongodb-combat:
        condition: service_healthy
      api-auth:
        condition: service_healthy
      api-monster:
        condition: service_healthy
      api-player:
        condition: service_healthy
    environment:
      <<: *api-env-base
      MONGO_HOST: mongodb-combat
      MONGO_DATABASE: combatdb
      AUTH_API_URL: ${AUTH_API_URL:-http://api-auth:8080}
      MONSTER_API_URL: ${MONSTER_API_URL:-http://api-monster:8080}
      PLAYER_API_URL: ${PLAYER_API_URL:-http://api-player:8080}

# ============================================
# Volumes
# ============================================
volumes:
  mongo-data-auth:
    driver: local
  mongo-data-player:
    driver: local
  mongo-data-monster:
    driver: local
  mongo-data-invocation:
    driver: local
  mongo-data-combat:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  gatcha-network:
    driver: bridge
