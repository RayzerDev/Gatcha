events {
    worker_connections 1024;
}

http {
    upstream auth-service {
        server api-auth:8080;
    }

    upstream player-service {
        server api-player:8080;
    }

    upstream monster-service {
        server api-monster:8080;
    }

    upstream invocation-service {
        server api-invocation:8080;
    }

    upstream combat-service {
        server api-combat:8080;
    }

    # Configuration du serveur principal
    server {
        listen 80;
        server_name localhost;

        # Logs
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # Headers communs
        add_header X-Gateway-Version "1.0";

        # Route vers Auth API
        location /api/auth/ {
            proxy_pass http://auth-service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route vers Player API
        location /api/player/ {
            proxy_pass http://player-service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route vers Monster API
        location /api/monster/ {
            proxy_pass http://monster-service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route vers Invocation API
        location /api/invocation/ {
            proxy_pass http://invocation-service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route vers Combat API
        location /api/combat/ {
            proxy_pass http://combat-service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check global
        location /health {
            access_log off;
            return 200 "Gateway is healthy\n";
            add_header Content-Type text/plain;
        }

        # Gestion des erreurs 404
        location @404 {
            return 404 '{"error": "Route not found", "message": "Check /health for available routes"}';
            add_header Content-Type application/json;
        }
    }
}

